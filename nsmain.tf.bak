terraform {
  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = ">= 2.20.0"
    }
  }
}

data "google_client_config" "default" {}

# Only read the cluster if it's expected to exist
data "google_container_cluster" "autopilot_cluster" {
  count    = var.create_gke_cluster ? 1 : 0
  project  = var.project_id
  location = var.cluster_region
  name     = var.cluster_name
}

resource "kubernetes_namespace" "namespaces" {
  for_each = var.create_namespaces ? toset(var.namespaces) : []
  provider = kubernetes

#  for_each = toset(var.namespace_names)

  metadata {
    name = each.value
    labels = {
      environment = var.environment
      project     = var.project_label
      team        = var.team
      created_by  = replace(var.created_by, ".", "-")
      managed_by  = var.managed_by
    }
  }
}
